;================================================================================================================================
;================================================================================================================================
;================================================================================================================================
;================================================================================================================================

BITS 64

;================================================================================================================================
;================ Imports =======================================================================================================
;================================================================================================================================

EXTERN  genericInterruptHandler

EXTERN  handlerTimer

EXTERN  handlerKeyboard

;================================================================================================================================
;================ Imports =======================================================================================================
;================================================================================================================================

GLOBAL  interruptsTest

GLOBAL  handlerDivideError
GLOBAL  handlerDebugException
GLOBAL  handlerNonmaskableExternalInterrupt
GLOBAL  handlerBreakpoint
GLOBAL  handlerOverflow
GLOBAL  handlerBOUNDRangeExceeded
GLOBAL  handlerInvalidOpcode
GLOBAL  handlerDeviceNotAvailable
GLOBAL  handlerDoubleFault
GLOBAL  handlerCoprocessorSegmentOverrun
GLOBAL  handlerInvalidTSS
GLOBAL  handlerSegmentNotPresent
GLOBAL  handlerStackSegmentFault
GLOBAL  handlerGeneralprotection
GLOBAL  handlerPageFault
GLOBAL  handlerFloatingPointError
GLOBAL  handlerAlignmentCheck
GLOBAL  handlerMachineCheck
GLOBAL  handlerFloatingPointException
GLOBAL  handlerVirtualizationException
GLOBAL  handlerInterruptError

GLOBAL  asmHandlerTimer
GLOBAL  asmHandlerKeyboard

;================================================================================================================================
;================================================================================================================================
;================================================================================================================================

SECTION .text
ALIGN   4

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    interruptsTest:

        MOV         RAX,                0x0A001234432100A0
        MOV         RBX,                0x0B001234432100B0
        MOV         RCX,                0x0C001234432100C0
        MOV         RDX,                0x0D001234432100D0

        MOV         R8,                 0x0123450
        MOV         R9,                 0x0123450
        MOV         R10,                0x0123450
        MOV         R11,                0x0123450
        MOV         R12,                0x0123450
        MOV         R13,                0x0123450
        MOV         R14,                0x0123450
        MOV         R15,                0x0123450

        INT         56

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    _handler:

        PUSH        56                                          ; RSP + 8
        PUSH        RAX                                         ; RSP + 0

        MOV         RAX,                [RSP + 24]
        MOV         [RSP + 8],          RAX

        PUSH        RBX
        PUSH        RCX
        PUSH        RDX

        PUSH        R8
        PUSH        R9
        PUSH        R10
        PUSH        R11
        PUSH        R12
        PUSH        R13
        PUSH        R14
        PUSH        R15

        MOV         RAX,                CR0
        MOV         RBX,                CR2
        MOV         RCX,                CR3
        MOV         RDX,                CR4
        PUSH        RAX
        PUSH        RBX
        PUSH        RCX
        PUSH        RDX

        CALL        genericInterruptHandler

        CLI                                                     ; CLI and HLT are called from C as well, just as a precaution.
        HLT

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerDivideError:

        PUSH        0

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerDebugException:

        PUSH        1

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerNonmaskableExternalInterrupt:

        PUSH        2

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerBreakpoint:

        PUSH        3

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerOverflow:

        PUSH        4

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerBOUNDRangeExceeded:

        PUSH        5

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerInvalidOpcode:

        PUSH        6

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerDeviceNotAvailable:

        PUSH        7

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerDoubleFault:

        PUSH        8

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerCoprocessorSegmentOverrun:

        PUSH        9

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerInvalidTSS:

        PUSH        10

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerSegmentNotPresent:

        PUSH        11

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerStackSegmentFault:

        PUSH        12

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerGeneralprotection:

        PUSH        13

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerPageFault:

        PUSH        14

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    ; Interrupt 15 is reserved by Intel.

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerFloatingPointError:

        PUSH        16

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerAlignmentCheck:

        PUSH        17

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerMachineCheck:

        PUSH        18

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerFloatingPointException:

        PUSH        19

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerVirtualizationException:

        PUSH        20

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    ; Interrupts 21 - 31 are reserved by Intel.

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    handlerInterruptError:

        PUSH        32

        CALL        _handler

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    ; Interrupt 40.

    asmHandlerTimer:

        PUSH        RAX
        PUSH        RBX
        PUSH        RCX
        PUSH        RDX

        PUSH        R8
        PUSH        R9
        PUSH        R10
        PUSH        R11
        PUSH        R12
        PUSH        R13
        PUSH        R14
        PUSH        R15

        CALL        handlerTimer

        POP         R15
        POP         R14
        POP         R13
        POP         R12
        POP         R11
        POP         R10
        POP         R9
        POP         R8

        POP         RDX
        POP         RCX
        POP         RBX
        POP         RAX

        IRETQ

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    ; Interrupt 41.

    asmHandlerKeyboard:

        PUSH        RAX
        PUSH        RBX
        PUSH        RCX
        PUSH        RDX

        PUSH        R8
        PUSH        R9
        PUSH        R10
        PUSH        R11
        PUSH        R12
        PUSH        R13
        PUSH        R14
        PUSH        R15

        CALL        handlerKeyboard

        POP         R15
        POP         R14
        POP         R13
        POP         R12
        POP         R11
        POP         R10
        POP         R9
        POP         R8

        POP         RDX
        POP         RCX
        POP         RBX
        POP         RAX

        IRETQ

    ;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

;================================================================================================================================
;================================================================================================================================
;================================================================================================================================
;================================================================================================================================
