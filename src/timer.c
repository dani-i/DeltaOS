// ================================================================================================================================
// ================================================================================================================================
// ================================================================================================================================

#include "timer.h"

// ================================================================================================================================
// ================================================================================================================================

static  QWORD   seconds = 0;
static  QWORD   ticks = 0;

// ================================================================================================================================
// ================================================================================================================================

// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

void    timerInitialization (void)
{
    irqClear (PIC1_INTERRUPT_TIMER);

    outB (
        PIT_MODE_COMMAND_W,
        PIT_16_BIT_MODE | PIT_OPERATING_MODE_3_SQUARE_WAVE_GENERATOR | PIT_ACCESS_MODE_LOBYTE_HIBYTE | PIT_CHANNEL_SELECTOR_CHANNEL_0
    );

    outB (
        PIT_IO_PORT_CHANNEL_0_DATA_RW,
        155
    );

    outB (
        PIT_IO_PORT_CHANNEL_0_DATA_RW,
        46
    );

    addInterrupt (asmHandlerTimer, INTERRUPT_TIMER, INTERRUPT, RING_0);
}

// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

void    handlerTimer (void)
{
    ticks++;

    if (0 == ticks % 100)
    {
        displayTime (ticks / 100);

        seconds++;
    }

    picSendEOI (PIC1_INTERRUPT_TIMER);
}

// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

QWORD   getTime (void)
{
    return seconds;
}

// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

void    sleep (QWORD wait_ticks)
{
    QWORD   wait_complete = ticks + wait_ticks;

    while (ticks <= wait_complete)
    {
        ;
    }
}

// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

// ================================================================================================================================
// ================================================================================================================================
// ================================================================================================================================
